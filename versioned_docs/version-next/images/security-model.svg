<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 620 645" fill="none">
  <style>
    text { font-family: system-ui, -apple-system, sans-serif; }
    .box { rx: 8; ry: 8; }
    .label { font-size: 14px; fill: #1a1a2e; font-weight: 600; }
    .sublabel { font-size: 11px; fill: #6b7280; }
    .arrow { stroke: #005799; stroke-width: 1.5; marker-end: url(#ah); }
    .heading { font-size: 20px; fill: #3b82f6; font-weight: 700; }
    .layer-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .layer-bg { rx: 12; ry: 12; }
  </style>
  <defs>
    <marker id="ah" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6" fill="#005799"/>
    </marker>
  </defs>

  <!-- Title -->
  <text class="heading" x="310" y="28" text-anchor="middle">v2 Security and Permissions Model</text>

  <!-- === Layer backgrounds (painted first, behind everything) === -->
  <rect class="layer-bg" x="10" y="48" width="600" height="100" fill="#f0fdf4" stroke="#00bc8e" stroke-width="1" stroke-dasharray="4 2" opacity="0.7"/>
  <rect class="layer-bg" x="10" y="180" width="600" height="90" fill="#f5f3ff" stroke="#6741d9" stroke-width="1" stroke-dasharray="4 2" opacity="0.7"/>
  <rect class="layer-bg" x="10" y="295" width="600" height="76" fill="#eff6ff" stroke="#005799" stroke-width="1" stroke-dasharray="4 2" opacity="0.7"/>
  <rect class="layer-bg" x="10" y="400" width="600" height="76" fill="#eff1f5" stroke="#002e5d" stroke-width="1" stroke-dasharray="4 2" opacity="0.7"/>
  <rect class="layer-bg" x="10" y="505" width="600" height="90" fill="#f0fdf4" stroke="#00bc8e" stroke-width="1" stroke-dasharray="4 2" opacity="0.7"/>

  <!-- === Layer labels === -->
  <text class="layer-label" x="310" y="66" text-anchor="middle" fill="#047857">KUBERNETES SECURITY LAYER</text>
  <text class="layer-label" x="310" y="198" text-anchor="middle" fill="#5b21b6">OPERATOR LAYER (PRIVILEGED)</text>
  <text class="layer-label" x="310" y="313" text-anchor="middle" fill="#1e40af">CONTROL PLANE</text>
  <text class="layer-label" x="310" y="418" text-anchor="middle" fill="#1e3a5f">HOST LAYER (UNPRIVILEGED)</text>
  <text class="layer-label" x="310" y="523" text-anchor="middle" fill="#047857">WASM SANDBOX (DEFENSE IN DEPTH)</text>

  <!-- === Boxes === -->

  <!-- Layer 1 boxes -->
  <rect class="box" x="20" y="80" width="130" height="44" fill="#e6f9f3" stroke="#00bc8e" stroke-width="1.5"/>
  <text class="label" x="85" y="98" text-anchor="middle">RBAC</text>
  <text class="sublabel" x="85" y="114" text-anchor="middle">CRD-scoped</text>

  <rect class="box" x="165" y="80" width="130" height="44" fill="#e6f9f3" stroke="#00bc8e" stroke-width="1.5"/>
  <text class="label" x="230" y="98" text-anchor="middle">Admission</text>
  <text class="sublabel" x="230" y="114" text-anchor="middle">Controllers</text>

  <rect class="box" x="310" y="80" width="130" height="44" fill="#e6f9f3" stroke="#00bc8e" stroke-width="1.5"/>
  <text class="label" x="375" y="98" text-anchor="middle">Namespace</text>
  <text class="sublabel" x="375" y="114" text-anchor="middle">Isolation</text>

  <rect class="box" x="455" y="80" width="140" height="44" fill="#e6f9f3" stroke="#00bc8e" stroke-width="1.5"/>
  <text class="label" x="525" y="98" text-anchor="middle">Network</text>
  <text class="sublabel" x="525" y="114" text-anchor="middle">Policies</text>

  <!-- Layer 2 boxes -->
  <rect class="box" x="80" y="210" width="200" height="40" fill="#f0ecff" stroke="#6741d9" stroke-width="1.5"/>
  <text class="label" x="180" y="234" text-anchor="middle">runtime-operator</text>

  <rect class="box" x="370" y="210" width="220" height="40" fill="#fff8e6" stroke="#d4a017" stroke-width="1.5"/>
  <text class="label" x="480" y="227" text-anchor="middle">K8s Audit Trail</text>
  <text class="sublabel" x="480" y="241" text-anchor="middle">all state changes</text>

  <!-- Layer 3 boxes -->
  <rect class="box" x="100" y="325" width="190" height="36" fill="#e6f0f7" stroke="#005799" stroke-width="1.5"/>
  <text class="label" x="195" y="347" text-anchor="middle">NATS (Protobuf API)</text>
  <text class="sublabel" x="350" y="347" fill="#1f2937">Hosts hold no K8s API credentials</text>

  <!-- Layer 4 boxes -->
  <rect class="box" x="100" y="430" width="200" height="36" fill="#e6ecf3" stroke="#002e5d" stroke-width="1.5"/>
  <text class="label" x="200" y="452" text-anchor="middle">wasmCloud Host</text>

  <!-- Layer 5 boxes -->
  <rect class="box" x="60" y="540" width="200" height="40" fill="#e6f9f3" stroke="#00bc8e" stroke-width="1.5"/>
  <text class="label" x="160" y="564" text-anchor="middle">Wasmtime Sandbox</text>

  <rect class="box" x="435" y="540" width="140" height="40" fill="#e6f9f3" stroke="#00bc8e" stroke-width="1.5"/>
  <text class="label" x="505" y="564" text-anchor="middle">Component</text>

  <!-- === Arrows and their labels (painted last, in foreground) === -->

  <!-- RBAC governs operator -->
  <text class="sublabel" x="38" y="165">governs</text>
  <polyline class="arrow" points="85,124 85,170 145,170 145,210" fill="none"/>

  <!-- Admission validates operator (routes left to clear layer label) -->
  <text class="sublabel" x="172" y="173">validates</text>
  <polyline class="arrow" points="230,124 230,160 165,160 165,210" fill="none"/>

  <!-- Operator to audit trail -->
  <text class="sublabel" x="325" y="222" text-anchor="middle" fill="#1f2937">logs changes</text>
  <line class="arrow" x1="280" y1="230" x2="370" y2="230"/>

  <!-- Operator down to NATS -->
  <text class="sublabel" x="195" y="287">protobuf API</text>
  <line class="arrow" x1="180" y1="250" x2="180" y2="325"/>

  <!-- NATS down to Host -->
  <line class="arrow" x1="195" y1="361" x2="195" y2="430"/>

  <!-- Host down to Sandbox (routes left around layer label) -->
  <polyline class="arrow" points="200,466 200,498 100,498 100,540" fill="none"/>

  <!-- Sandbox to Component -->
  <text class="sublabel" x="348" y="550" text-anchor="middle">only granted capabilities</text>
  <line class="arrow" x1="260" y1="560" x2="435" y2="560"/>

  <!-- Footer note -->
  <text class="sublabel" x="310" y="630" text-anchor="middle">Components can only access capabilities explicitly granted through host interfaces</text>
</svg>
